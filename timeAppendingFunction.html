<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>Time appending function</title>
      <link rel="stylesheet" href="style.css">
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/live/3.0/firebase.js"></script>
    <script src="map.js"></script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDtU7Z_r_-qxKBRmrC7TYUbPkYp1ECJJgE&callback=initMap">
    </script>
    <script src="weatherAjax.js"></script>
  </head>

  <body>
    <div class="container">
      <div class= "row">
        <div class="col-lg-12">
          <div id="map">
          </div>
        </div>
        </div>
        <div class="row">
          <div id="weather">
        </div>
      </div>
      <div class="col-lg-12">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title">Add Event</h3>
          </div>
          <div class="panel-body">
            <div id="userName"></div>
            <form role="form">
              <div class="form-group">
                <label for="location-input">Select Location</label>
                <select class="form-control" id="location-input">
                  <option>Please pick a location..</option>
                  <option>Bennu Coffee</option>
                  <option>Epoch Coffee</option>
                  <option>Mozarts Coffee Roasters</option>
                  <option>Radio</option>
                  <option>Wright Bros</option>
                  <option>Thunderbird Coffee</option>
                  <option>Dominican Joe</option>
                  <option>Figure 8</option>
                </select>
              </div>
              <div class="form-group">
                <label for="arrival-input">Arrival</label>
                <input class="form-control" id= "arrival-input" type= "time">
              </div>
              <div class="form-group">
                <label for="departure-input">Departure</label>
                <input class="form-control" id="departure-input" type="time">
              </div>
              <!-- <div class="form-group">
                <label for="status-input">Status:</label>
                <select class="form-control" id="status-input">
                  <option>Checked In</option>
                  <option>Checked Out</option>
                </select>
              </div> -->
              <button class="btn pretty" id="add-userSchedule" type="button">Submit</button>
            </form>
          </div>
        </div>
      </div>
      <br>
      <div class="col-lg-12">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title">Event Schedule</h3>
          </div>
          <table class="table table-striped">
            <thead>
              <tr>
                <th><b>Location</b></th>
                <th><b>User</b></th>
                <th><b>Arrival Time</b></th>
                <th><b>Departure Time</b></th>
                <th><b>Status</b></th>
              </tr>
            </thead>
            <tbody class="tableData">
            </tbody>
          </table>
        </div>
      </div>
    </div>

  <script type="text/javascript" src="login.js"></script>

  <script>

  //checks if user has logged in
  if (name[0] === undefined) {
    window.location.replace("login.html");
  }

  updateWeather();
  //global variables//
  var eventStart;
  var eventEnd;
  var location;
  var userName;
  var userArrival;
  var userDeparture;
  var userStatus;
  var thisMeetUp = {};
  var allMeetUps = {};
  var allUsers = [];
  var userCount = 1;
  var overWriteTime = false;
  var overWriteUser = false;
  var overbookedCheck = [];
  var users = [];
  var userTime = [];
  var overLapStart;
  var overLapEnd;

  // Create a variable to reference the database
  var database = firebase.database();

  //displays user's name
  $("#userName").html('<h3>' + name + '</h3>');

  //location selector//
  $("#add-userSchedule").on("click", function(event)
  {
    event.preventDefault();

    ///defining methods inside of click event//
    var printUserSchedule = function() {
     $(".tableData").append(" <tr><td> "
      + location + "</td><td>"
      + name + "</td><td>"
      + userArrival+"</td><td>"
      + userDeparture + "</td><td>"
      + userStatus );
    };

    var findEventStart =  function(beginTime) {
// console.log(eventStart);
// console.log(beginTime);
      if ( eventStart === undefined || eventStart === "Invalid date") {
        eventStart = moment(beginTime, "hh:mm a").format("hh:mm a");
      }

      else if (moment(eventStart, "hh:mm a").isAfter(moment(beginTime, "hh:mm a"))) {
        eventStart = moment(beginTime, "hh:mm a").format("hh:mm a");
      }
console.log(eventStart);
    };

    var findEventEnd =  function(stopTime) {
// console.log(eventEnd);
// console.log(stopTime);
      if ( eventEnd === undefined || eventEnd === "Invalid date") {
        eventEnd = moment(stopTime, "hh:mm a").format("hh:mm a");
      }

      else if (moment(eventEnd, "hh:mm a").isBefore(moment(stopTime, "hh:mm a"))) {
        eventEnd = moment(stopTime, "hh:mm a").format("hh:mm a");
      }
        // $("#" + location + "End").html(eventEnd);
// console.log(eventEnd);
    };

    var preventUserStupidity = function() {
      if (moment(userArrival, "hh:mm a").isAfter(moment(userDeparture, "hh:mm a"))) {
        alert("try again stupid");
      }
      else {
        findEventStart(userArrival);
        findEventEnd(userDeparture);
      };
    };

    function createMeetUp(name, location, userArrival, userDeparture) {
      for ( i=0; i < overbookedCheck.length; i++) {
        console.log(overbookedCheck[i]);
        for (ix = 0; ix < overbookedCheck[i][1].length; ix++) {
          if (name === overbookedCheck[i][1][ix].name) {
            console.log(name +" = " +overbookedCheck[i][1][ix].name);
            overLapStart = moment(overbookedCheck[i][1][ix].userArrival, "hh:mm a").format('hh:mm a');
            overLapEnd = moment(overbookedCheck[i][1][ix].userDeparture, "hh:mm a").format('hh:mm a');
            if (moment(userArrival, "hh:mm a").isBefore(moment(overLapEnd, "hh:mm a")) && moment(overLapStart, "hh:mm a").isBefore(moment(userDeparture, "hh:mm a"))) {
              alert("You can't double book yourself, this time overlaps another time you already selected");
              return;
            }
            else if (moment(userArrival, "hh:mm a") === moment(overLapStart, "hh:mm a") && moment(userDeparture, "hh:mm a") === moment(overLapEnd, "hh:mm a")) {
              alert("You can't double book yourself, this time overlaps another time you already selected");
              return;
            }
          }
          console.log(overbookedCheck[i][1][ix].name);
        }
      }

      var snapy =[];
      var timy = [];

      database.ref("/meetUps/"+location).on("child_added", function(snapshot, prevChildKey) {
        overWriteTime = false;
        overWriteUser = false;

        var dbSnap = snapshot.val();
        snapy = dbSnap;
        timy.push(dbSnap);

        if (dbSnap.userCount === 1) {
          userCount = dbSnap.userCount + 1;
        }
        else {
          userCount = 1;
        }

        if (dbSnap.userArrival === userArrival && dbSnap.userDeparture === userDeparture) {
          overWriteUser = true;
        }
        else{
          overWriteTime = true;
        }
      });

      if (snapy) {
        allUsers = snapy;
      }

      if (allUsers.indexOf(name) === -1){
        var userPush = {
          name: name, 
          userArrival: userArrival,
          userDeparture: userDeparture,
        }
        allUsers.push(userPush);
      }
// console.log("allusers "+allUsers);
      if (overWriteTime) {
        findEventStart(timy[0]);
        findEventEnd(timy[2]);
        var newMeetUpData = {
          location: location,
          userArrival: eventStart,
          userDeparture: eventEnd,
          users: allUsers,
          userCount: userCount,
        };
      }
      else {
        var newMeetUpData = {
          location: location,
          userArrival: userArrival,
          userDeparture: userDeparture,
          users: allUsers,
          userCount: userCount,
        };
      } 
// console.log(newMeetUpData.users);
// console.log("meetupdata " + newMeetUpData);

      return database.ref("/meetUps/"+location).set(newMeetUpData);   
    }

    var location = $("#location-input").val();
    var userName = name
    var userArrival = moment($("#arrival-input").val(), "hh:mm a").format('hh:mm a');
    var userDeparture = moment($("#departure-input").val(), "hh:mm a").format('hh:mm a');
    preventUserStupidity();
    createMeetUp(name,location,userArrival,userDeparture);


  });

  function displayMeetUp() {


    var count = 0;

    database.ref("/meetUps").on("value", function(snapshot) {
      $(".tableData").empty();

      newMeetUp = snapshot.val();

      $.each(newMeetUp, function(index, value) {

        getUserStatus(value.userArrival, value.userDeparture);
console.log(value);
console.log(value.users);
console.log(value.users[0].name);


// console.log(newMeetUp);
// console.log(snapshot);

        // CREATE TABLE

        // ROW
        var meetUpLine = $("<tr id=\"meetUp" + count + "\">");

        // CELL - ORGANIZOR NAME
        var meetOrganizor = $("<td id=\"organizor" + count + "\">");

        // CELL - LOCATION
        var meetLocation = $("<td id=\"location" + count + "\">");

        // CELL - START TIME
        var meetStart = $("<td id=\"start" + count + "\">");

        // CELL - END TIME
        var meetEnd = $("<td id=\"end" + count + "\">");

        // CELL - DURATION
        var meetDuration = $("<td id=\"duration" + count + "\">");

        // CELL - STATUS
        var meetStatus = $("<td id=\"status" + count + "\">")

        // APPEND CELLS TO ROW

        meetUpLine.append(meetOrganizor);

        meetUpLine.append(meetLocation);

        meetUpLine.append(meetStart);

        meetUpLine.append(meetEnd);

        meetUpLine.append(meetStatus);

        // APPEND TO EXISTING TABLE - deezMeetUps
        
        $(".tableData").append(meetUpLine);
        var users = [];
        var userTime = [];
        // WRITE TO SCREEN
        for (i = 0; i < value.users.length; i++) {
          users.push(value.users[i].name);
          userTime.push(value.users[i]);
        }
        console.log(userTime);
        $("#organizor" + count).html(users.join(", "));

        $("#location" + count).html(value.location);

        $("#start" + count).html(value.userArrival);

        $("#end" + count).html(value.userDeparture);

        $("#status" + count).html(userStatus);

        overbookedCheck[count] = [
            locality= value.location,
            peopleHere= userTime
          ]
        
        // (value.location, users)
// console.log("new functionality " + overbookedCheck);
// console.log(overbookedCheck[0]);
// console.log(overbookedCheck[1]);
  // for ( i=0; i < overbookedCheck.length; i++) {
  //   // console.log(overbookedCheck[i][1]);
  //   console.log(overbookedCheck[i]);
  //   for (ix = 0; ix < overbookedCheck[i][1].length; ix++) {
  //     if (name === overbookedCheck[i][1][ix].name) {
  //       console.log(name +" = " +overbookedCheck[i][1][ix].name);
  //       overLapStart = moment(overbookedCheck[i][1][ix].userArrival, "hh:mm a").format('hh:mm a');
  //       overLapEnd = moment(overbookedCheck[i][1][ix].userDeparture, "hh:mm a").format('hh:mm a');
  //       if (moment(userArrival, "hh:mm a").isBefore(overLapEnd) && overLapStart.isBefore(moment(userDeparture, "hh:mm a"))) {
  //         alert("You can't double book yourself, this time overlaps another time you already selected");
  //         return;
  //       }
  //       else if (moment(userArrival, "hh:mm a") === overLapStart && moment(userDeparture, "hh:mm a") === overLapEnd) {
  //         alert("You can't double book yourself, this time overlaps another time you already selected");
  //         return;
  //       }
  //     }
  //     console.log(overbookedCheck[i][1][ix].name);
  //   }
  // }

        startTime = parseInt(value.userArrival);
        eventStart = moment(value.userArrival, "hh:mm a").format('hh:mm a');

        endTime = parseInt(value.userDeparture);
        eventEnd = moment(value.userDeparture, "hh:mm a").format('hh:mm a');

        // Calculate duration.


        if (endTime - startTime < 100) {
            duration = (endTime - startTime);
            $("#duration" + newMeetUp.count).html(duration + " minutes");
        } else {
            duration = (endTime - startTime) / 100;
            $("#duration" + newMeetUp.count).html(duration + " hours");
        }
        count ++;
      })
    }, function(errorObject) {
      console.log("Errors handled: " + errorObject.code);
    });

    function getUserStatus(arrivalTime, departureTime) {
      if (moment(moment(),"hh:mm a").isBefore(moment(arrivalTime,"hh:mm a"))) {
        userStatus = "Pre-Arrival"
      }
      else if (moment(moment(),"hh:mm a").isAfter(moment(departureTime,"hh:mm a"))) {
        userStatus = "Departed"
      }
      else {
        userStatus = "Present";
      }
    };
  }
  displayMeetUp();

  </script>

  </body>
</html>
